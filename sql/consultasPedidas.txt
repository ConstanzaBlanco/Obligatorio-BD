-- Salas más reservadas
SELECT nombre_sala, COUNT(*) AS cant_reservas
        FROM reserva
        GROUP BY nombre_sala
        ORDER BY cant_reservas DESC

-- Turnos más demandados
SELECT r.id_turno, t.hora_inicio, t.hora_fin, COUNT(*) AS total_reservas
        FROM reserva r
        JOIN turno t ON t.id_turno = r.id_turno
        WHERE r.estado IN ('activa','finalizada')
        GROUP BY r.id_turno, t.hora_inicio, t.hora_fin
        ORDER BY total_reservas DESC
        LIMIT 10;

-- Promedio de participantes por sala
SELECT nombre_sala, AVG(cant_participantes) AS promedio_participantes 
        FROM (
            SELECT r.id_reserva, r.nombre_sala, COUNT(rp.ci_participante) AS cant_participantes 
            FROM reserva r 
            LEFT JOIN reserva_participante rp ON rp.id_reserva = r.id_reserva 
            GROUP BY r.id_reserva, r.nombre_sala
        ) AS sub 
        GROUP BY nombre_sala;

-- Cantidad de reservas por carrera y facultad
SELECT f.nombre AS facultad, pa.nombre_programa, COUNT(*) AS cantidadReservas
        FROM reserva r
        JOIN reserva_participante rp ON r.id_reserva = rp.id_reserva
        JOIN participante_programa_academico ppa ON ppa.ci_participante = rp.ci_participante
        JOIN programa_academico pa ON pa.nombre_programa = ppa.nombre_programa
        JOIN facultad f ON f.id_facultad = pa.id_facultad
        GROUP BY f.nombre, pa.nombre_programa;

-- Porcentaje de ocupación de salas por edificio (ARREGLAR PROBLEMA DE HORA)
SELECT st.edificio,
               ((CASE WHEN so.salas_ocupadas IS NULL THEN 0 ELSE so.salas_ocupadas END) 
                 / st.cantidad_salas * 100) AS porcentaje_ocupadas
        FROM (SELECT edificio, COUNT(*) AS cantidad_salas FROM sala GROUP BY edificio) st
        LEFT JOIN (
            SELECT r.edificio, COUNT(*) AS salas_ocupadas
            FROM reserva r
            JOIN turno t ON r.id_turno = t.id_turno
            WHERE r.fecha = CURDATE()
            AND CURRENT_TIME BETWEEN t.hora_inicio AND t.hora_fin
            AND r.estado = 'activa'
            GROUP BY r.edificio
        ) so ON st.edificio = so.edificio;

-- Cantidad de reservas y asistencias de profesores y alumnos (grado y posgrado)
SELECT p.nombre, p.apellido,
       SUM(CASE WHEN rp.asistencia = TRUE THEN 1 ELSE 0 END) AS asistencias,
       COUNT(*) AS cantidadReservas,
       ppa.rol, pa.tipo
        FROM reserva_participante rp
        JOIN participante p ON rp.ci_participante = p.ci
        JOIN participante_programa_academico ppa ON ppa.ci_participante = p.ci
        JOIN programa_academico pa ON pa.nombre_programa = ppa.nombre_programa
        GROUP BY p.ci, p.nombre, p.apellido, ppa.rol, pa.tipo;

-- Cantidad de sanciones para profesores y alumnos (grado y posgrado)
SELECT ppa.rol, pa.tipo, COUNT(sp.ci_participante) AS cant_sanciones
        FROM sancion_participante sp
        JOIN participante_programa_academico ppa ON sp.ci_participante = ppa.ci_participante
        JOIN programa_academico pa ON ppa.nombre_programa = pa.nombre_programa
        GROUP BY ppa.rol, pa.tipo
        ORDER BY ppa.rol, pa.tipo;

-- Porcentaje de reservas efectivamente utilizadas vs. canceladas/no asistidas
SELECT
        (SUM(CASE WHEN estado = 'sin asistencia' THEN 1 ELSE 0 END) / COUNT(*) * 100) AS NoUtilizadas,
        (SUM(CASE WHEN estado = 'finalizada' THEN 1 ELSE 0 END) / COUNT(*) * 100) AS Utilizadas
    FROM reserva;

-- Participantes con más reservas en el mes
SELECT p.ci, p.nombre, p.apellido, COUNT(*) AS cant_reservas
        FROM participante p
        JOIN reserva_participante rp ON p.ci = rp.ci_participante
        WHERE MONTH(rp.fecha_solicitud_reserva) = MONTH(CURRENT_DATE)
        AND YEAR(rp.fecha_solicitud_reserva) = YEAR(CURRENT_DATE)
        GROUP BY p.ci, p.nombre, p.apellido
        ORDER BY cant_reservas DESC
        LIMIT 3;


-- Promedio de duración de sanción por participante
SELECT p.ci,
               (CASE WHEN sp.ci_participante IS NOT NULL 
                     THEN AVG(DATEDIFF(fecha_fin, fecha_inicio))
                     ELSE 0 END) AS promedio_dias
        FROM sancion_participante sp
        RIGHT JOIN participante p ON sp.ci_participante = p.ci
        GROUP BY p.ci;

-- Día de la semana con más reservas MARTIN
 SELECT DAYNAME(r.fecha) AS dia_semana,
       DAYOFWEEK(r.fecha) AS num_semana,
       COUNT(*) AS total_reservas
        FROM reserva r
        WHERE r.estado IN ('activa','finalizada')
        GROUP BY dia_semana, num_semana
        ORDER BY total_reservas DESC
        LIMIT 1;